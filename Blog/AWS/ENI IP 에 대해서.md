
#  IP

***ip*** 는 4가지가 존재한다.

| Public     | Public    | Private    | Private              |
| ---------- | --------- | ---------- | -------------------- |
| Elastic IP | Public IP | Private IP | Secondray Private IP |

이 **IP** 중 독립 상태로 존재할수있는 **ip** 는 ***Elastic IP*** 만 가능하다

반면, ***Public IP*** 와 ***Private IP*** 는 반드시 ***ENI*** 를 동반해야 한다
이러한 ***IP*** 는 ***ENI*** 의 생명주기와 함께한다.

***public IP*** 는 ***ENI*** 뿐만 아니라 인스턴스와 같은 컴퓨팅 서비스가 반드시 필요하다.

이는 ***Amazon IPv4 Pool*** 에서 할당하지만, 계정이 마음대로 보유할수 없고 인터페이스 작업과 형태에 따라 기존 ***IP*** 를 유지하기도 하고 다른 ***IP*** 로 변경되기도 한다.

## ENI

**ENI** 는 기본 프라이빗 IP 가 반드시 설정돼 있어야 한다
다시말해 **기본 프라이빗 IP 는 1:1 관계를 유지**한다.

가령 **ENI** 에 **프라이빗 IP** 가 3개 할당된 상태라면 1개는 **기본 프라이빗**, 나머지는 2개의  **보조 프라이빗 IP** 이다.

**Elastic IP** 는 **프라이빗 IP** 와 쌍을 이룬다.
탄력적 IP 를 연결하는 대상은 사실 ENI 가 아닌 ENI 에 할당된 프라이빗 IP 이다.

프라이빗 IP 종류와 무관하게 탄력적 IP 를 연결할 수 있다.

퍼블릭 IP 는 ENI 뿐 아니라 인스턴스와 같은 컴퓨팅 서비스가 반드시 필요하다.

그러므로 다음 과 같이 독립적 ENI 에 할당할수 없다.

```sh
-------
| ENI | O-> [Private] O-> [Public]
-------

독립 ENI 에 퍼블릭 IP 할당(불가)
```

**Instance** 는 하나의 기본 ENI 와 연결되거나 다수의 ENI 와 연결될수 있다.

기본 ENI 는 인스턴스 생성 즉시 연결되며, 오직 1개만 존재한다.
사용자가 추가한 ENI 는 분리할수 있다.

```sh
-----------         ---------------
| Instance | O----O | Primary ENI |
-----------         ---------------
[ 기본 ENI 가 연결된 Instance]

-----------         ---------------
| Instance | O----O | Primary ENI |
|          |        ---------------
|		   | O----O -----------------
------------		| Secondary ENI |
					-----------------
[ 기본 ENI 와 보조 ENI 가 연결된 Instance ]
```

다음은 인스턴스 유형별 ENI 와 프라이빗 IP 최대 개수의 표이다

| 인스턴스 유형   | 최대 네트워크 인터페이스 수 | 인터페이스당 프라이빗 IPv4 주소 수 | 인터페이스당 IPv6 주소 수 |
| --------- | --------------- | --------------------- | ---------------- |
| t2.micro  | 2               | 2                     | 2                |
| t2.small  | 3               | 4                     | 4                |
| t2.medium | 3               | 6                     | 6                |
| t2.large  | 3               | 12                    | 12               |
| ...       | ...             | ...                   | ...              |
| t3.nano   | 2               | 2                     | 2                |

인스턴스 유형별 연결 가능한 최대 ENI 수와 ENI 당 프라이빗 IP 수가 정리된 표의 일부이다.
**t3.nano** 유형을 사용하면 최대 2개의 ENI 를 연결할수 있으므로, 다음처럼 기본 ENI 에 추가 ENI 하나만 더 연결할 수 있다.

![[인스턴스 유형별 ENI]]

인스턴스는 각각 기본 프라이빗 ENI 와 보조 프라이빗 ENI 를 연결한것을 볼수있다.
위의 T3 는 각각 1개씩 연결되어있지만, T2 는 기본 프라이빗 ENI 1개와 2개의 보조 프라이빗 ENI 를 연결한것을 볼 수 있다.

다음은 t2.medium 인스턴스에 할당한 보조 프라이빗 IP 이다.

![[t2.medium 인스턴스 할당한 ENI]]

t2.medium 유형 인스턴스에 최대 3개 ENI 를 연결한 모습이다.
기본 ENI(보라색) 은 추가 ENI(자주색) 이 절대 소유할 수 없는 퍼블릭 IP 가 할당돼 있다.

ENI 마다 프라이빗 IP 를 6개까지 할당할 수 있으므로, 기본 프라이빗  IP 1개를 제외하면 ENI 마다 최대 5개 보조 프라이빗 IP 를 할당할 수 있다.

> 탄력적 IP 는 프라이빗 IP 와 한쌍을 이룬다.
> 따라서 ENI 에 2개 이상의 탄력적 IP 도 연결할 수 있다.

##  퍼블릭 IP 자동 할당

인스턴스 생성 시점에 퍼블릭 IP 를 동시에 소유하는 방법은 동적 퍼블릭 IP 를 할당하는 방법뿐이다.

> 탄력적 IP 는 인스턴스 생성이후에 연결할 수 있다,

***Public IP 자동 할당*** 옵션을 사용해서 Public IP 를 할당한다

1. Enable 은 인스턴스 기본 ENI 에 Public IP 를 할당
2. Disabled 는 Public IP 할당하지 않음
3. Use subnet setting 은 서브넷 설정값에 따랄 Public IP 할당 여부 결정

> ***Use subnet setting*** 옵션은 다음의 ***Subnet*** 의 ***Public IPv4 주소 자동 할당(Auto-assign public IPv4 address)*** 옵션이 존재한다.
>
> 이 옵션은 default 값으로 No 이며, 생성후 Yes 로 변경할수 있다.
> 이러한 옵션값을 보고 Public IP 할당 여부를 결정한다.

이는 다음의 그림과 같다.

![[Public IP 자동 할당 옵션에 따른 순서도]]

## ENI 연결과 탄력적 IP 할당

기본 Private IP 만을 가진 ENI 에 퍼블릭 IP 를 할당받는 방법은 Elastic IP 를 사용하는 것이다.
탄력적 IP 는 다음 3가지 방법으로 인스턴스에 연결할 수 있다.

1. 인스턴스에 직접 연결(Associate)하는 방법
> 인스턴스 ID 와 인스턴스가 소유한 프라이빗 IP 를 지정


2. 인스턴스가 사용하는 ENI 에 직접 연결
> ENI 와 ENI 가 소유한 프라이빗 IP 를 지정	

3. 탄력적 IP 를 ENI 에 할당한뒤, 해당 ENI 를 인스턴스에 연결(Attach)

이는 다음의 순서도와 같다.

![[탄력적 IP 연결 해제 및 ENI 연결 분리 프로세스]]

이는 탄력적 IP 를 Instance 에서 연결하는지, ENI 에서 연결하는지, ENI 생성후 연결된 Elastic IP 를 Instance 에 부착하는지에 따라 처리 방식이 달라진다.

> 다시한번 말하지만, ENI 는 Private IP 를 기본값으로 할당되며, Elastic IP 는 이러한 Private IP 에 1:1 로 대칭시켜 할당하는 공개 IP 이다.

> 이는 기본 ENI 의 Private IP 에도 할당가능하고, 보조 ENI 의 Private IP 에도 할당가능하다

### 동적 퍼블릭 IP 가 없는 인스턴스의 성질

- 생성 시점부터 동적 퍼블릭 IP 가 없는 인스턴스는, 탄력적 IP 작업과 ENI 작업이 자유롭다. 단, 기본 ENI 연결/분리는 불가능하다.
- 탄력적 IP 는 프라이빗 IP 와 쌍을 이루므로, 모든 프라이빗 IP(기본, 보조) 에 연결할 수 있다. 다시말해 ENI 에 기본 프라이빗 IP 와 보조 프라이빗  IP 가 다수 할당돼 있으면, 하나의 ENI 에 2개 이상의 탄력적 IP 를 연결할 수 있다.
- 위 2개 규칙은 인스턴스 상태와 무관하며, ENI 가 3개이상일대도 똑같이 적용된다.

## 동적 퍼블릭 IP

인스턴스는 생성 시점에 Public IP 를 할당받는다.

Public IP 는 계정과 무관하며, Amazon IPv4 Pool 에서 직접 할당한 IP 이다.
이는 Instance 의 상태가 바뀔때 마다 혹은 탄력적 IP 할당/해제 시점마다 기존 퍼블릭 IP 가 릴리스 되거나 새로운 Public IP 가 ENI 에 할당된다.

![[네트워킹 작업에 따른 퍼블릭 IP 변화 과정]]

- 인스턴스를 재부팅하면 퍼블릭 IP 보유 여부와 무관하게 기존 상태를 유지한다 <br> 다시 말해 퍼블릭 IP 를 보유한 상태라면 기존 퍼블릭 IP 를 유지하고 퍼블릭 IP 가 없었다면 <br> 재부팅해도 새로 할당되지 않는다.

- 인스턴스를 중지하면 현재 퍼블릭 IP 를 Amazon IPv4 Pool 로 반환(Release)한다. 이미 반환된 IP 는 다시 살릴수 없다.
 
- 퍼블릭  IP 를 반환한 인스턴스는 언제나 새로운 퍼블릭 IP 를 할당받을 준비태세(Potential) 을 갖추고 있다. 그러므로 ENI 에 퍼블릭 IP 가 없다고 해서 모두 같은 상태로 볼 수 없다.
  ![[프라이빗 인스턴스와 잠재적 퍼블릭 인스턴스]]

- 실행중인 인스턴스에 ENI 를 추가 연결해도 기존 퍼블릭 IP 를 잃지 않는다. 재부팅 이후라도 현재 상태를 유지한다. ENI 를 분리해도 마찬가지다.

- 추가 ENI 를 연결한 상태에서 인스턴스를 중지하면 퍼블릭 IP 가 Release 된다. 그러나 이상태에서 어떤 작업(Start, Stop, Reboot) 을  해도 새로운 퍼블릭 IP 를 할당받지 못한다.

  ![[추가 ENI 를 연결한 상태의 인스턴스 중지]]

> 인스턴스가 중지된 상태에서 부팅(6 -> 6) 또는 Start(4 -> 3) 할때 Amazon IPv4 Pool 에서 새로운 IP를 할당 받는다. 이때 2가지를 확인한다.
> 내가 이해하기로는 1번은 추가 ENI 가 있을경우의 조건이다.
> 
	1. 인스턴스가 기본 ENI 가 있는지 확인한다 있다면 Public IP 를 할당받지 않는다.(6 번부분인것을 보면 추가 ENI 가 있을경우 중지된 상태를 말하는듯하다.)
	2. 추가 연결된 ENI 가 없다면 기본 ENI 에 탄력적 IP 가 연결되었는지 확인한다. 연결되지 않았다면 새로운 퍼블릭 IP 를 할당받는다 (4 -> 3 부분으로 이 경우 추가 ENI 가 없는경우를 말하는듯 싶다)
	
> 추가 ENI 가 없는 상황을 같이 고려해서 설명해서 약간 혼란이 왔다. 

- 인스턴스에서 ENI 를 분리한다고 해서 퍼블릭 IP 를 바로 할당받지 못한다. 그러나 중지한후 부팅하면 새로운 퍼블릭 IP 를 할당받을수 있다. [[추가 ENI 를 연결한 상태의 인스턴스 중지]] 의 ***6 -> 3 -> 4***  부분을 참조하자.

- 퍼블릭 IP 가 할당된 ENI 에 탄력적 IP 를 연결하면 기존 Public IP 는 릴리스된다. 반대로 이 탄력적 IP 를 해제하면 새로운 퍼블릭 IP 를 Amazone IPv4 Pool 에서 할당받는다.

**인스턴스 생성시 퍼블릭 IP 를 할당받으면 그 꼬리표는 절때 뗄수 없다.**
물론 인스턴스에 가하는 작업에 따라 퍼블릭 IP 를 임시 소멸시킬수 있지만 인스턴스는 새로운 퍼블릭 IP 를 할당받으려는 잠재적 부활 본능이 있다.

> Potential 부분을 보면 알수 있다..

책에서 말하기로는 인터넷 사용 여부가 확실치 않은 인스턴스는 생성시 퍼블릭 IP 할당을 하지 않아야 하며, 생성시점에 프라이빗 IP 만 보유하는것이 좋다고 한다.

이후 인터넷 접속이 확정되면 탄력적 IP 나 NAT Gateway 를 사용하는것이 바람직하다.

## 보조 프라이빗 IP 에 탄력적 IP 할당

보조 프라이빗 IP 에서 탄력적 IP 만 다시 해제할순 있지만, 탄력적 IP 만 유지한채 보조 프라이빗 IP 만 해제할수는 없다.

이는 보조 프라이빗 IP 와 탄력적 IP 는 1:1 관계로 연결되기 때문이다.
성질은 다음과 같다.

![[네트워킹 작업에 따른에 따른 퍼블릭 IP 변화 과정 2]]

탄력적 IP 가 인스턴스와 연결되지 않고 리전에 할당받은 상태로 홀로 존재하거나 인스턴스에 2개 이상 연결하면 비용이 부관된다.

그러나 인스턴스에 1개만 연결하면 탄력적 IP 비용은 무료이다.

