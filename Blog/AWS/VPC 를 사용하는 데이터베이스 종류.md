<hr>

#vpc #aws #rds #eni 

> [ 참고책 ] AWS VPC 네트워킹 원리와 보안

##  VPC 네트워킹을 사용하는 서비스

| DB 서비스<br>               | VPC 기반 | RDS 용 ENI | 퍼블릭 엑세스 |
| :----------------------- | ------ | --------- | ------- |
| RDS                      | o      | o         | o       |
| Neptune                  | o      | o         | x       |
| Amazon DocumentDB        | o      | o         | x       |
| ElasticCache             | o      | x         | x       |
| Redis 용 Amazon Memory DB | o      | x         | x       |
| DynamoDB                 | x      | x         | x       |
| Amazon QLDB              | x      | x         | x       |
| Amazon Keyspaces         | x      | x         | x       |
| Amazon Timestream        | x      | x         | x       |

VPC 네트워킹을 사용하는 서비스는 총 5개이며, 이는 VPC 보안 통제영역에 있다

이중 **ENI** 를 사용하는 **DB** 는 **RDS용 ENI** 를 사용한다.
이러한 **RDS용 ENI** 를 사용하는 **DB** 는 총 3개로 **RDS, Neptune, Amazon DocumentDB** 이다.

> 책에서는 **SDK** 를 사용할때 주의점이 있다고 한다.
> 
> **RDS용 ENI** 를 사용하는 위의 3 가지 **DB** 는 **ENI** 의 정보(설명)이 **RDSNetworkInterface** 으로 작성되었으므로, 이를 보고 **RDS DB** 라 생각하면 안된다는것이다.
>
> 구분하기 위해서는 데이터베이스 종류를 보고 구분하라고 한다.

인터넷에서 접속 가능한 퍼블릭엑세스 기능은 **RDS** 에만 있다
퍼블릭 엑세스 기능은 정해진 포트로만 접속가능하기 때문에, ACL 이나 보안 그룹의 규칙을 광범위하게 지정해도 효과는 없다.

ACL 이 다른 서비스와 연결되어 있다면, 이러한 접속 범위를 한정하는것이 보안상 필요하다.

## RDS 서브넷 그룹의 특징

**서브넷 그룹**은 **서브넷의 묶음**이다

> 서브넷 그룹을 사용하는 서비스는 대표적으로 RDS, Redshift 가 있다고 한다.

RDS 를 생성하려면 서브넷 그룹 1개를 바드시 지정해야 한다
서브넷은 가용영역에 생성되고, 가용 영역의 목적이 가용성인 것을 알고 있다면 RDS 가 왜 서브넷 그룹을 지정해야 하는지 추측할 수 있다.

서브넷 그룹은 **RDS** 가 놓일 **서브넷의 집합**이다

> 한 가용영역의 RDS 의 서비스가 중지되었다면, 다른 가용영역의 RDS 가 대신 처리하는 방식이다

![[VPC 와 가용영역에 생성된 서브넷 그룹]]

이미지를 보면, 가용영역에 걸쳐있는 VPC 내부에 여러 Subnet 들이 존재한다.
이는 RDS 가 속할 Subnet 들의 집합을 의미한다

> 1.  서브넷 그룹은 VPC 에 종속되며, 최소 2개 이상의 가용영역을 지정해야 한다.
> 2. 모든 RDS 는 생성단계에서 서브넷 그룹을 지정해야 한다.
> 3. RDS 생성 전에 서브넷 그룹을 만들어 둬야 한다. 미리 준비한 서브넷 그룹이 없다면, RDS 를 생성하기 전에 **새 DB 서브넷 그룹 생성옵션**을 사용할수 있다.

## RDS 서브넷 그룹의 역할

**RDS** 는 **서브넷 그룹의 맴버중 하나를 RDS 인스턴스 생성 위치로 선정**한다

>**AWS 의 가용영역** 은 **가용성**을 고려해서 만들었으며, **서브넷은 VPC 와 가용영역의 교차지점( 집합으로는 교집합 )** 에 생성된다.
>
>이말은 각 가용영역에 서브넷이 생성되며, VPC 는 가용영역에 걸쳐서 범위를 포함할수 있으므로, VPC 범위내의 서브넷은 서로 통신이 가능하다.
>
>RDS 를 이러한 서브넷 그룹을 사용하여 **Replica Set**  구성도 가능하다.
>이를 위해서는 **Multi-AZ** 를 사용하여, 자동으로 데이터 복제가 이루어지도록 처리해주어야 한다.

> **Amazon Aurora** 를 제외한 모든 엔진이 서브넷 그룹 변경을 지원한다

#### 서브넷 그룹 변경 조건

1. **서브넷 그룹을 변경하기 위해서는 단일 RDS 이어야만한다**.
> 예를 들어 서브넷 그룹을 변경하기 위한 RDS 가 Multi-AZ 라면, 서브넷 그룹을 변경하지 못하므로, Mulit-AZ 를 단일 RDS 로 변경한후, 다시 Multi-AZ 로 확장해야 한다.

 2. **다른 VPC 의 서브넷으로만 변경가능하다.** 
> 이는 현재 VPC 의 서브넷그룹의 멤버로는 변경 불가능하며, 변경하기 위해서는 다른 VPC 의 서브넷 그룹의 멤버로 변경해야 한다

3. **현재 구동중인 RDS 인스턴스의 가용영역이,  변경 대상 서브넷 그룹에도 포함되어야 한다.** 

![[RDS 인스턴스를 서브넷 그룹 변경을 위한 예]]

위의 예시는 RDS 를 서브넷 그룹이 존재하지 않은 VPC2 로 변경은 되지 않는다는것을 보여준다.

위의 VPC1 은 첫번째 조건과 같이 단일 RDS 로써 존재한다.
반면,  2번째 조건과 같이 VPC1 에서 다른 VPC 인 VPC3 의 서브넷 그룹으로 변경하는것은 가능하다

또한 3번째 조건인 구동중인 RDS 의 인스턴스의 가용영역에 변경 대상 서브넷 그룹에도 포함되므로 VPC3 의 ap-northeast-2b 의 Subnet Group C 로 변경되는것이다

**1, 2, 3 번의 변경 조건에 모두 해당하므로 VPC3 의 Subnet Group C 로 변경된다**

추가적으로 설명되는 조건이 존재하는데, 이는 **Public Access Option** 이 활성화된 상황일때 필요하다

1. **변경 대상 VPC 에도 인터넷 게이트웨이가 연결돼 있어야 한다**<br>단, 서브넷 라우팅 타깃에 인터넷 게이트웨이 지정 여부까지는 검사하지 않는다

2. **DNS 확인 (DNS resolution), DNS 호스트이름(DNS hostname) 이 활성화 되어 있는지 확인한다.**

**이는 서브넷 그룹의 변경은 결국 VPC 변경이라는것을 알수 있다**

## 다중 AZ 배포

RDS 는 Aurora 와 이외의 엔진 유형으로 구분한다

AWS 가 제공하는 모든 RDS 는 엔진유형과 템플릿 에 따라 방식의 차이는 있지만, 모두 **Multi-AZ** 를 사용해 서비스 장애를 대비한다

**Aurora 는 서브넷 그룹의 맴버 서브넷에 읽기나 쓰기 노드를 중복으로 둬 데이터 가용성을 높인다**
**Aurora 이외 엔진은 기본 인스턴스 장애가 발생하면 보조 AZ 의 인스턴스로 장애 조치돼 서비스를 지속할 수 있다.**

| 인스턴스                    | 접근성 및 설명                | Aurora | Aurora 외 |
| :---------------------- | ----------------------- | ------ | -------- |
| Primary DB Instance[^1] | W + R (Endpoint 있음)[^2] | o      | o        |
| Reader[^3]              | R (Endpoint 있음)         | o      | x        |
| Standby Replica[^4]     | 접근불가(Endpoint 없음)       | x      | o        |
| Reader 추가               | 읽기 추가                   | o      | o        |
| Reader (Read Node)      | 읽기 노드                   | o      | x        |
| Read Replica            | 읽기 전용 복제본               | x      | o        |

---

[^1]: 기본 생성되는 인스턴스가 있다. 추가 인스턴스 없이 단일 기본 인스턴스만 사용하면 Single AZ 라 한다 Single AZ 도 Multi AZ 로 변경가능하다. 이러한 확장성 조건으로 인해 Single AZ 도 서브넷 그룹에 속해야 한다.

[^2]: 쓰기 작업은 기본적으로 읽기 작업을 포함한다. 그러므로 기본 인스턴스를 Write Node 라 한다

[^3]: Aurora 의 다중 AZ 는 쓰기와 읽기가 가능한 기본 인스턴스 1개와 여러 Reader 로 구성된다. 복제본 리더(Read Replica)는 추가하거나 삭제할수 없다

[^4]: Aurora 외의 RDS Multi AZ 는 쓰기와 읽기가 가능한 기본 인스턴스 1개와 동기식 예비 복제본(Standby Replica) 인스턴스 1개로 구성된다. Standby Replica 는 ENI 가 있으나 접근이 불가능하며, 기본 인스턴스에 서비스 장애가 발생할때만 기본 인스턴스로 승격된이후 접근 가능하다

---

위의 내용을 정리하면, 상이한 점은 다음과 같다.

1. **Aurora 는 자동적으로 Reader 를 생성하는 반면, Aurora 외 서비스는 Multy-AZ 시에 Standby-Reader 를 생성한다.**<br><br>Aurora 의 Reader 는 Read Node 로 접근가능하지만, StandbyReader 는 접근 자체가 불가능하며 오직 기본 Instance 로 승격된다음 접근 가능하다.

2. **Reader 추가시 Aurora 는 Reader (Read Node) 를 생성하지만, Aurora 외 서비스는 Read Replica 를 생성한다**<br><br>Aurora 의 Reader 는 읽기 전용 DB 와 함께 고가용성을 위한 장애조치 인스턴스로서도 활용된다.<br><br>반면, Aurora 외의 서비스는 Read 하기 위해서 새로은 Read Replica 를 생성한다. 이는 오직 읽기전용 DB 이며 고가용성을 위해 DB 인스턴스 데이터를 동기화하는 Standby Replica 와는 다른 개념이다.

---

아래는 Aurora 의 Reader, Writer, Failover 상황에 따른 작동 방식이다.

![[Aurora 의 변화과정]]

이는 **Reader** 가 **장애 조치에 대한 대체 인스턴스로써의 역할** 및 **읽기 전용 DB** 로써 사용됨을 볼수 있다

다음은 Aurora 외 RDS 의 다중 AZ 방식을 보여준다.

![[MYSql Instance 변화 과정]]

읽기 복제본 추가시 비동기적으로 복제되어 일긱 전용으로 접근 가능하다. 비동기적이라는건, Sync 처럼 동기화되기 보다는 약간의 지연이 걸릴수 있는 작업이다.

이는 다음과 같다.

1. **지연된 데이터 복제**<br>주 DB 인스턴스에서 쓰기 작업이 수행이후에 Read Replica 까지 복제되기까지 약간의 시간이 소요될수 있다. 이 지연 시간은 밀리초에서 많게는 초단위로 이루어질수 있다.
2. **읽기 일관성 보장** <br>지연된 데이터 복제로 인해 기본 DB 인스턴스와 Read Replica DB 인스턴스간의 데이터가 상이하여 일관성을 보장하기 어렵다. 이는 고가용성과 성능향상을 목적으로 사용되며, 데이터 일관성이 필수적이라면 다른 방법을 사용해야 한다.
3. **읽기 전용 용도**<br>Read Replica 는 읽기 전용 작업을 수행한다. 이말은 Write 작업은 할수 없으며, 오직 기본 DB 인스턴스에서만 수행 가능하다. 읽기 전용 작업을 분산하는 목적으로 사용하기 용이하다

 Aurora 는 더 나은 고가용성을 제공하기 위해 Read Replica 가 아닌 Reader 가 읽기 전용 DB 이면서, Standby Replica 의 역할도 겸한다.
 
이러한 특성때문인지 Aurora 는 비동기적으로 Read Node 들과 데이터를 복제하는 방식을 가진다.
이는 읽기 일관성 보장 및 데이터 복제 지연역시 발생할수 있다는 점을 알아두는것이 좋다.

