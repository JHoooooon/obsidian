
---

## VPC 네트워킹의 개념

>[!info]
> ENI 를 사용하면서, Security Group, ACL, Routing Table 의 통제 영역에 있으면 VPC 네트워킹을 사용한다고 말한다
>
> ENI 의 존재만으로도 VPC 네트워킹 사용을 확신할수 있다

여기서 말하는 통제 3요소인 **Security Group, ACL, Routing Table** 은 **ENI 를 보호**하고 **트래픽의 방향을 안내**한다.

## 접근제어

**Access Control** 은 필요한 트래픽만 허용하고 불필요한 트래픽의 접근은 차단하여, 컴퓨팅 서비스를 보호하는 장치이다

**VPC** 는 **보안그룹과 ACL 로 이러한 트래픽의 허용 / 차단하는 역할**을 한다

보통의 온프레미스 환경의 트래픽 접근 허용은 FireWall 이 처리한다.
이러한 Firewall 의 접근 제어 방식은 총 2가지이다

1. **White List**
2. **Black List**

White List 방식은 접근을 허용하는 트래픽을 제외하고는 모두 차단한다
반면, Black List 방식은 접근을 차단하는 트래픽을 제외하고는 모두 허용한다

반면 이러한 방식을 사용하여 하이브리드 접근 방식을 사용하기도 한다

1. **White List based**
2. **Black List based**

![[Hybrid 방식 접근제어]]

**White List based** 방식은 **All Deny 규칙을 최하단에 놓고, 그 위로 Allow 및 Deny 규칙을 혼합해서 배치한다**

**Black List based** 방식은 **All Allow 규칙을 최하단에 놓고, 그 위로 Allow 및 Deny 규칙을 혼합해서 배치한다**

모든 트래픽을 기본 허용하는 2가지 블랙 방식은 관리자가 차단 대상을 모두 알고 있어야 하므로 관리가 까다로워 단독 사용이 어렵다

따라서, 화이트 리스트 방식과 이중 보안 체계를 구성하는게 좋다.

다음을 보면 **Whitelist based** 를 사용하여 다음처럼 구성했다고 하자

![[Whitelist based 규칙 순서에 따른 결과]]

왼쪽은 Allow, 오른쪽은 Deny 되는것을 볼수 있다.
이는 트래픽 접근시 차단 규칙의 순서가 중요하다는것을 볼 수 있다

AWS 에서는 **SG(Security Group) 이 Wihtelist 방식**을 사용하며, **NACL(Network Access Control List) 이 Hibrid 방식**을 사용한다

그러므로, 규칙 순서가 중요한 **NACL 은 Rule Number 를 사용**하며, **SG 는 Rule Number 를 사용하지 않는다.**

### SG 의 표면적 특징과 다중 연결성

**SG 는 VPC 의 보안통제 3요소중 하나로 ENI 로 들어오거나 나가는 트래픽 접근을 제어한다**

#### 보안 그룹의 특징 
- **SG 의 Parent 는 VPC 이다**
- **SG 의 연결대상은 ENI 이며, 수명 주기동안 다른 ENI 에 연결할수 있다**
- **컴퓨팅 ENI 는 수명 주기 동안 반드시 SG 와 연결되어야 한다**
- **SG 는 다중연결 특징이 있다**
1. **1:N 연결성:** 1 개 SG 를 여러 ENI 에 연결할 수 있다. 역할마다 SG 를 구분하고 생성하고 서비스 역할에 따라 관련 SG 를 연결하면 유용하다
2. **N:1 연결성:** 여러 SG 를 1개 ENI 에 연결할 수 있다. 서비스 하나에 여러 역할이 필요할 때 유용하다
- **기본 VPC 를 포함한 모든 VPC 가 생성될때 기본 SG 도 함께 생성된다. 즉 VPC 와 SG 의 개수는 같다**

>[!info] 
>
>N:1 연결성에 의해 여러 SG 가 한개의 ENI 에 연결될 경우, Rule Number 가 필요하지 않을까? 결과는 아니다. 여러 SG 가 연결되더라도 Whitelist 를 기반으로 하는 SG 는 들어오는 트래픽이 해당 규칙에의해 Allow 되기만 하면 허용한다.
> 
> 지정된 IP 만 맞으면 통과 된다는것이다

### SG 의 규칙 및 형태

흔히 온프레미스의 Firewall 같은 경우 규칙을 정하는 방식은 다음과 같다

| Allow/Deny | Source       | Destination  | Protocol | Port Range |
| :--------- | ------------ | ------------ | -------- | ---------- |
| Allow      | 160.82.25.60 | 92.75.100.25 | TCP      | 80         |
| Allow      | 92.75.100.25 | 160.82.25.60 | TCP      | 22<br>     |

보면 4가지 규칙이 맞아 떨어져야 트래픽을 허용하는것을 볼수있다.

ENI 같은경우 자체적인 IP 가 지정되어 있기에, Inbound 트래픽같은경우 목적지가 자기자신이고, Outbound 트래픽 같은경우 출발지가 자기자신이다.

이말은 Inbound 트래픽같은경우 Source 만 입력하면 되고, Outbound 같은경우 Destination 만 입력하면 된다는 말이다.

이는 Friwall 같이 모든 규칙을 지정하기 보다는 통신대상만 source 및 destination 으로 입력하기만 하면 된다.

> [!warning]
> 물론 Protocol 과 Port 는 입력해주어야 한다


### SG Source/Destination 에 SG 허용

SG 의 source 와 destination 에 대한 기입은 트래픽을 허용하는지와 관련되어 있다.

이는 Client 에서 Outbount 의 destination 을 Server 의 IP 를 지정함으로써, 트래픽을 내보내고 Server 는 Client 를 받을수있도록 Inbound 의 Source 에 Client 의 IP 를 지정하여 트래픽을 받는 구조이다.

하지만, 여러 Client 가 하나의 Server 에 접속해야 하는 상황이면 어떻게 해야 할까?
아마 다음처럼 Inbound 에 모든 IP 를 Inbound 로 작성할 것이다

![[여러 클라이언트를 IP 주소로 Inbound 에 연결]]


[[#보안 그룹의 특징]] 에서 언급했듯, SG 는 1:N 방식으로 ENI 연결이 가능하다고 하였다.
이러한 특징을 사용하여 여러 Client 에 Server 의 IP 를 Outbound 한 하나의 SG 를 생성하여 연결한다  

그리고 Server 에서의 Inbound SG 에 Client 의 SG 를 Source 로써 등록하면 어렵게 모든 Client 를 하나하나 Inbound SG 로 등록할 필요없이 간단하게 연결가능하다

이는 다음의 그림과 같다

![[여러 클라이언트를 Outbound 및 Inbound 를 SG 로 연결]]

간단하게 Destination 과 Source 를 연결한 SG 로 처리하면 쉽게 처리가능하다
이는 다음과 같이 해석된다

- **인바운드 규칙 대상의 SG 를 가진 컴퓨팅 서비스는 접속허용**
- **아웃바운드 규칙 대상의 SG 를 가진 컴퓨팅 서비스는 접속 허용**

SG 를 지정하여 처리하면 규칙 관리가 매우 편리해 진다

>[!warning]
책에서 의도하지 않은 접속 허용으로 구성되므로, SG 사용시 불피요한 SG 는 인스턴스에서 해제하도록 권장하고 있다. 
>
>이는 접속허용을 의도한 컴퓨팅 서비스가 아닌 의도하지 않은 컴퓨팅 서비스가 같은 SG 를 사용할 경우, SG 로 연결되어 있기에, 접근을 허용하기 때문이다.

>[!info]
이러한 SG 관리를 잘한다면 IP 로 주소를 관리하는 방식보다 AWS 내에서 작동하는 SG 로 관리하기에 접속대상이 내부로 한정된다. 이는 더 안전하게 사용가능하다는 뜻이기도 하다

### NACL 표면적 특장과 다중 연결성(1:N)

>[!info]
>NACL  은 VPC 의 보안 통제 3 요소 중 하나로 서브넷을 통과하는 트래픽 접근을 제어한다

#### NACL 의 특징

1. NACL 의 패런트는 VPC 이다
2. NACL 의 연결대상은 서브넷이며, 수명주기 동안 다른 서브넷과 연결할수 있다.
3. 서브넷은 수명 주기 동안 반드시 NACL 과 연결돼있어야만 한다. 서브넷은 단 하나의 NACL 을 사용하지만 NACL 로 변경가능하다
4. 기본 VPC 및 VPC 가 생성될때마다 기본 NACL 도 같이 생성된다. 기본 NACL 과 VPC 개수는 같다
5. 서브넷 생성 단계에서 서브넷에 연결할 NACL 을 지정할 수 없다. 서브넷을 생성하면 무조건 기본 NACL 에 자동 연결된다

### NACL 규칙의 형태

NACL 규칙의 형태는 SG 와 유사하다
단, Hybrid 방식을 채택하여, 순서에 영향을 받으므로 Rule number 와 Allow/Deny 속성이 존재한다

| Rule Number | Type     | Protocol | Prot Range | Source          | Allow/Deny |
| :---------- | -------- | -------- | ---------- | --------------- | ---------- |
| 100         | HTTP(80) | TCP(6)   | 80         | 160.83.25.60/32 | Allow      |
| *           | 모든트래픽    | 모두       | 모두         | 0.0.0.0/0       | Deny       |

위는 160.83.25.60/32 을 제외한 모든 트래픽을 허용하지 않는다

아래는 Blacklist based 방식으로 변경한 NACL 규칙이다

| Rule Number | Type     | Protocol | Prot Range | Source          | Allow/Deny |
| :---------- | -------- | -------- | ---------- | --------------- | ---------- |
| 100         | HTTP(80) | TCP(6)   | 80         | 160.83.25.60/32 | Deny       |
| 200         | 모든트래픽    | 모두       | 모두         | 0.0.0.0/0       | Allow      |
| *           | 모든트래픽    | 모두       | 모두         | 0.0.0.0/0       | Deny       |

위는 다음처럼 동작한다

**100 -> 200 -> \**** 

그러므로, 100 을 먼저 차단하고, 200 을 실행하니, 160.83.25.60/32 을 차단한 나머지를 모두 허용한다
\* 은 200 에 의해 자동적으로 무시된다.

### 접근 제어 방식 비교: Stateful VS Stateless

>[!info]
>TCP 통신은 3-way handshake 방식으로 논리적 세션을 형성하고, 클라이언트와 서버 사이 데이터를 주고 받는다

SG 는 최초 접속 규칙만 입력해도 통신할 수 있도록 설계되어있다.
이는 인바운드 규칙만 있어도 클라이언트가 SG 를 통과해 서버에 접속하는 과정에서 SG 는 클라이언트의 IP 와 Port 를 저장하고 응답시 이를 load 하여 보낸다

> [!info]
> 이렇게 네트워크 통신상에 요청값을 저장해서 사용하는 방식을 상태를 간직한다고 해서 Stateful 하다고 표현한다

이는 다음의 원리로 작동한다

![[SG 패킷 허용 원리]]

이를 통해 SG 는 Stateful 방식으로 처리되는것이라 볼 수 있다
반면, NACL 은 Stateless 방식으로 처리된다

![[NACL 패킷 허용 원리]]

보면 상태값을 저장해서 사용하는게 아닌 기입한 Outbound 의 내용을 확인한후 허용하는것을 볼 수 있다.

>[!warning]
동적 포트는 운영체제의 종류마다 포트범위가 다르다. 서버는 자신에게 접속하느 클라이언트의 운영체제 종류를 모두 알수 없으므로, 포트 범위를 제한하는 방법으로 원활한 서비스 제공이 어렵다.<br><br>그러므로 모든 포트를 허용하는것을 권장한다

NACL 을 화이트 방식으로 사용하면 다음과 같은 문제가 발생한다

- **인바운드 규칙에 허용된 IP 를 아웃바운드 규칙에도 적용해야 한다**
- **클라이언트의 동적 포트를 허용해야 한다**
- **SG 에 신규 허용 규칙을 등록할때마다 NACL 도 함께 등록해야 한다. 이는 NACL 은 서브넷에 속한 모든 서비스의 접근 제어에 관여해야 한다**

좀더 효율적인 처리를 위한 블랙 방식을 만든 방법은 아래와 같다

