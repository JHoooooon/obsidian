
`Page` 로드시 `Service Worker` 의 `code` 가 페이지를 관리하지 못하는 것 처럼 보이고, 페이지를 여러번 새로고침 해야 했던 경험이 있을 것이다.

`Service Worker` 코드를 변경하고 새로고침했지만, 변경되지 않는 경우도 존재한다.

이를 해결하기 위해 페이지가 새로고침될때 마다 `Service Worker` 에 변경사항이 있는지 알수 있는 `Update on reload` 모드를 사요할수 있지만, 권장하지는 않는다.

이는 `cheat key` 같은 것으로, 새로고침해야 하는 문제를 해결해주지만, `service` 사용자에게 권장할수 있는 방법은 아니다.

 `Service Worker` 의 특성을 처음 접할때 혼란스러울수 있다.
 이는 `Service Worker` 의 생명주기와 연관되어 있어, 알게되면 명확하게 이해할수 있다.

다음은 `sw.js` 의 내용이다.

```js
// install event
self.addEventListener("install", () => {
	console.log("install");
});

// activate event
self.addEventListener("activate", () => {
	console.log("activate");
});

self.addEventListener("fetch", (event) => {
	if (event.request.url.includes("bootstrap.min.css")) {
		console.log(`Fetch request for: ${event.request.url}`);
		event.respondWith(
			new Response(
				`.hotel-slogan { background: green!important; }
				 nav { display: none }`,
				{ headers: { "Content-Type": "text/css" } }
			)
		);
	}
});
```

## 서비스 워커의 생명주기

`page` 가 새로운 서비스워커를 등록하려면 여러 단계의 상태를 거쳐야 한다.

![[Service worker lifecycle.png]]

### Installing

`navigator.serviceWorker.register` 를 사용하여 `service worker` 를 등록할 때, `javascript` 가 다운로드 되고 `parsing` 이 끝나면, `service worker` 는 `installing` 상태에 들어선다.  

`installing` 이 완료되면, `installed` 상태로 변하게 된다.
만약 `error` 가 `throw` 되면, `page` 를 `refresh` 하여 `service worker` 를 다시 등록하거나, `Redundant` (`더이상 사용하지 않는`) 상태로 존재한다. 

>[!info] Redundant (중복)
>이는 `service worker` 는 더이상 클라이언트 요청을 처리하지 않으며, 서비스가 중단되 상태임을 말한다.<br><br>이는 `service worker` 가 더이상 유효하지 않는다는 신호이다.<br><br>책에서는 `중복` 이라고 쓰는데, 이상하다. 이는 `불필요한 상태` 혹은 `더이상 사용되지 않는 상태`  로의 뜻으로 쓰이는게 덜 헷갈리겠다.

`waitUntil` 을 호출하면, `Installing` 상태를 `Promise` 가 `settled` 될때 까지, 상태는 변경되지 않고 여전히 `Installing` 상태를 유지한다.

`Promise` 가 `Resolve` 되면, `Installed` 상태로, `Reject` 되면 `Redundant` 상태가 된다.



