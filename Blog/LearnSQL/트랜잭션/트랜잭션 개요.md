
`SQL` 은 애플리케이션 로직에서 논리적 작업 단위로 함께 실행되는 여러 `SQL`  문을 포함하는 경우가 많다.

이렇게 `SQL` 문의 집합을 그룹화 할때 사용하는 매커니즘이 `트랜잭션` (`Transaction`) 이다.

## 다중 사용자 데이터베이스

>[!info] 데이터베이스 관리 시스템은 단일 사용자가 데이터를 쿼리하고 수정할 수 있지만, 오늘날에는 수천명의 사용자가 동시에 데이터베이스를 사용할수도 있다.

일반적으로 쿼리를 실행한다면 별 문제가 없다.
하지만, 동시에 데이터를 추가 또는 수정할때 서버는 많은 `부기`(`Bookkeeping`) 를 처리해야 한다.

>[!note] `부기` (`Bookeeping`) 은 **계산내용을 장부에 기록**  하는 것을 말한다.<br><br>회계학에서 사용되는 용어인듯한데, 한글 번역이 한자어인듯하다.<br> 개인적으로 `Bookeeping` 이 더 와 닿는다.

만약 애플리케이션을 사용해서 영화 대여 내역을 요약하는 보고서를 작성하면 다음의 프로세스가 진행된다고 가정하자

1. **고객이 영화를 대여**
2. **고객이 반납일 이후 영화를 반납하고 연체료 지불**
3. **5 편의 새로운 영화가 재고에 추가**

이렇게 보고서가 작성되는 동안에도 사용자는 지속적으로 데이터를 수정한다.
그럼 보고서에 작성된 기존의 내용이 수정되기도 하며, 충돌이 일어나기도 한다.

이럴때 이러한 충돌을 예방하며 일관성을 제공하기 위해, 서버의 `LOCKING` 처리 방법을 사용한다.

## 잠금 (`LOCKING`)

잠금은 데이터베이스 서버가 데이터 자원을 동시 사용을 제어하는데 사용되는 매커니즘이다.

데이터베이스의 일부가 잠기면, 해당 데이터를 수정하거나 읽으려는 다른 사용자는 잠금이 해제될때 까지 기다려야 한다.

대부분의 데이터베이스 서버는 다음 두가지 잠금 방식중 하나를 사용한다.

1.  **`Writer` 는 데이터를 수정하기 위해 `Write Lock` 을 서버에 요청하고 수신해야 하며,<br>`Reader` 는 데이터를 ㅈ회하기 위해 `Read Lock` 을 요청하고 수신헤야 한다.**<br><br>여러 사용자가 동시에 데이터를 읽을 수 있지만 각 테이블에 대해 한번에 하나의 `Write Lock` 만 제공하고, `Write Lock` 이 해제될때까지는 `Read` 요청이 차단된다.


2. **`Writer` 는 데이터를 수정하기 위해 `Write Lock` 을 서버에 요청하고 수신하지만, `Reader` 가 데이터를 조회할 때는 어떠한 유형의 잠금도 필요하지 않다.**<br><br>서버는 쿼리가 시작될때부터 쿼리가 완료될때까지 `Reader` 에게 데이터에 대한 일관된 보기를 제공한다.<br><br>이로 인해 다른 사용자가 수정을 하더라도 데이터는 동일하게 보이며, 이러한 방식을 `버전관리`(`Versioning`) 이라 한다.


>[!info] `MSServer` 는 첫번째 접근방식을, `Oracle` 은 두번째 방식을, `MySQL` 은 엔진에 따라 $2$ 가지 방식 전부를 제공한다.

### 잠금 단위

리소스를 잠글 때 사용할수 있는 여러가지 방법이 있다.
서버는 세가지 다른 수준 또는 `단위` (`Granularity`) 중 하나에서 잠금을 적용한다

- **Table locks**<br>여러 사용자가 동일한 테이블의 데이터를 동시에 수정하지 못하도록 한다.

- **Page locks**<br>여러 사용자가 테이블의 동일한 페이지의 데이터를 동시에 수정하지 못하도록 한다.
>[!note] 한 페이지는 보통 $2KB$ 에서 $6KB$ 범위의 메모리 세그먼트이다.

여러 사용자가 테이블에서 동일한 행을 동시에 수정하지 못하도록 한다.

이러한 접근 방식은 장단점이 있다고 말한다.
전체 테이블을 잠그는데 `Bookkeeping` 이 거의 필요하지 않다.
사용자 수가 증가함에 따라 대기 시간이 빠르게 증가한다.

행잠금은 훨씬더 많은 `Bookkeeping` 이 필요하지만 많은 사용자가 각자 다른 행에 대해 작업한다면 동일한 테이블을 수정할 수 있다.

>[!info] `MSServer` 는 `페이지`, `테이블` ,`행 잠금` 을 사용하며, `Oracle` 은 `행 잠금` 만 사용하며, `MySQL` 은 `테이블`, `페이지` 또는 `행 잠금` 을 사용한다.

>[!info] `MySQL` 은 `Storage Engine` 에 따라 다르다.

`SQL Server` 는 특정 상황에서 행에서 페이지로, 페이지에서 테이블로 잠금을 `Escalation` 하지만, `Oracle` 은 잠금을 `Escalation` 하지 않는다.







