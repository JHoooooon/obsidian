`집계 함수` 는 그룹의 모든 행에 대해 특정 연산을 수행한다.

모든 데이터베이스 서버는 고유한 `distinct` 특별 집계 함수를 포함하지만, 대부분의 서버에서 가지고 있는 공통 집계 함수는 다음과 같다.

- **MAX**(): 집합내의 최댓값 반환
- **MIN**(): 집합의 최솟값 반환
- **AVG**(): 집합의 평균값 반환
- **SUM**(): 집합의 총합 반환
- **COUNT**(): 집합의 레코드 수를 반환

#### 영화 대여료 데이터 분석 쿼리

공통 집계 함수를 사용해서 영화 대여료의 데이터를 분석하는 쿼리다

```mysql
SELECT 
	MAX(amount) max_amt,
	AVG(amount) avg_amt,
	MIN(amount) min_amt,
	SUM(amount) tot_amt,
	COUNT(*) num_payment,
FROM payment;
```

```sh
max_amt|avg_amt |min_amt|tot_amt |num_payment|
-------+--------+-------+--------+-----------+
  11.99|4.201356|   0.00|67406.56|      16044|
```

`amount` 를 사용하여, 집계함수로 계산된 결과를 반환한다.

### 명시적 그룹과 암시적 그룹

`GROUP BY` 절이 없는데, `집계함수` 를 사용하면 `암시적 그룹` 이라 한다.
반면, `GROUP BY` 절을 명시적으로 선언하면, `명시적 그룹` 이라 할수 있다.

앞전의 [[#영화 대여료 데이터 분석 쿼리]] 는 `GROUP BY` 절 없이 사용했으니 단일 `암시적 그룹` 이라 할수 있다.

앞의 [[#영화 대여료 데이터 분석 쿼리]] 에서는 `암시적` 으로 `payment` 의 모든 행이다.

> [!info] 이러한 경우 `테이블의 모든 행` 이 `GROUP BY` 대상이 된다<br>그러므로, 집계함수에 외의 `field` 를 `SELECT` 하려고 하면, `ERROR` 가 발생한다.

만약, 다음처럼 `amount` 가 아닌 다른 `field` 를 사용하면, 데이터베이스는 그룹지어져야할 `field` 를 알수없어 `ERROR` 가 발생한다.

```mysql
SELECT 
	customer_id,
	MAX(amount) max_amt,
	AVG(amount) avg_amt,
	MIN(amount) min_amt,
	SUM(amount) tot_amt,
	COUNT(*) num_payment
FROM payment;
```

```sh
SQL Error [1140] [42000]: In aggregated query without GROUP BY, expression #1 of SELECT list contains nonaggregated column 'sakila.payment.customer_id'; this is incompatible with sql_mode=only_full_group_by
```

>[!warning] 
>`GROUP BY 절 없이 집계된 쿼리를 사용했다` 는 것과 더불어 추가적으로  `SELECT` 목록에 비집계된 `sakila.payment.customer_id` 의 `column` 이 포함되었으며,<br> 
>이는 `sql_mode=only_full_group_by` 에 의해 호환되지 않는다는 에러가 발생한다 

>[!info]
 `SELECT` 리스트, `ORDER BY` 목록 혹은 `HAVING condition` 에서 `GROUP BY` 절에 명시되지 않은 `column` 을 사용할때 쿼리를 거부한다, `GROUP BY` 절에 종속되지 않은 집계되지 않은 열을 참조하는 쿼리를 거부한다  
 

이러한 에러는 `GROUP BY` 에 의해 `명시적` 으로 지정해야 한다는 의미이다

```mysql
SELECT 
	customer_id,
	MAX(amount) max_amt,
	AVG(amount) avg_amt,
	MIN(amount) min_amt,
	SUM(amount) tot_amt,
	COUNT(*) num_payment,
FROM payment
GROUP BY customer_id
LIMIT 5;
```

```sh
customer_id|max_amt|avg_amt |min_amt|tot_amt|num_payment|
-----------+-------+--------+-------+-------+-----------+
          1|   9.99|3.708750|   0.99| 118.68|         32|
          2|  10.99|4.767778|   0.99| 128.73|         27|
          3|  10.99|5.220769|   0.99| 135.74|         26|
          4|   8.99|3.717273|   0.99|  81.78|         22|
          5|   9.99|3.805789|   0.99| 144.62|         38|
```

이는 `customer_id` 를 그룹화 하고, 각 `customer_id` 의  `amount` 를 집계함수로 계산한다.

### 고유한 값 계산

각 그룹에서 `COUNT()` 함수를 사용할 때, 그룹의 모든 `customer_id` 수를 계산할지 (중복포함),
아니면 그룹의 모든 `customer_id` 중에 `고유한 값`(`distinct value`) 에 대해서만 계산할지 선택할 수 있다

```mysql
SELECT 
	COUNT(customer_id) num_rows,
	COUNT(DISTINCT customer_id) num_customers	
FROM payment;
```

```sh
num_rows|num_customers|
--------+-------------+
   16044|          599|
```

쿼리의 첫 번째 열은 단순히 `payment` 테이블의 행 수를 계산하는 반면 두번째 열은 `customer_id` 의 값을 비교해서 고유한 값을 가지는 `customer_id` 의 수만 계산한다.

