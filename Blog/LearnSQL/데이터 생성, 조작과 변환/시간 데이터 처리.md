
---

>[!info] [[데이터베이스 생성 및 자료형]]에서 문자열 데이터의 대한 개요를 볼 수 있다.

`시간 데이터` 는 데이터의 생성 및 조작과 관련이 깊다
`시간 데이터` 는 데이터의 생성 및 조작과 가장 관련이 깊다 

이는 날짜와 시간을 설명하는 많은 방법들로 인해 복잡성이 증가한다.

- $Wednesday, June 5, 2019$
- $6/05/2019 2:14:56 P.M EST$
- $6/05/2019 19:14:56 GMT$
- $1562019 (Julian format)$
- $Star date [-4] 97026.79 14:14:56 (Star trek format)$

이러한 여러 시간데이터를 처리하는 방법이 필요하다

---

## 시간대 처리

> [!note] `time zone` 은 $24$ 개의 가상 영역으로 분할된다
특정 시간대에 있는 모든 사람은 현재 시간에 동의하는 반면, 다른 시간대의 사람은 동의하지 못한다
**일부 지역에서는 $1$ 년에 두차례에 걸쳐 $1$ 시간씩 시간을 옮기며 (서머타임) 나머지 지역은 그렇지 않다**

이러한 부분을 통해서, 공통적인 참조 기준을 위해 $15 th$ 항해사들이 사용한 `그리니치 표준시` (`GMT`) 와의 시간 차이로 나타낼수있다

모든 시간대는 `GMT` 와의 시간차이로 나타낼수 있다
`동부 표준시` 로 알려진 미국 동부 시간대는 `GMT -5:00` 또는 `GMT 5:00` 빠른 시간으로 나타낼수 있다.

또는 `Coordinated Universal Time` (`UTC`) 라는 `협정 세계표준시` 라는 변현된 `GMT` 를 사용한다
이는 `SQL Server`, `MySQL` 모두 현재 `UTC` 타입스템프를 반환하는 함수를 제공한다

>[!note] `MySQL` 은 `utc_timestamp()` 함수 제공

`MySQL` 에서는 데이터베이스에 로그인한 각 사용자에 따라 `Global Timezone` 과 `Session Timezone` 으로 서로 다른 두가지 `Timezone` 을 지원한다

```mysql
SELECT @@global.time_zone, @@session.time_zone;

@@global.time_zone|@@session.time_zone|
------------------+-------------------+
SYSTEM            |SYSTEM             |
```

`system` 값은 데이터베이스가 설치된 서버의 표준 시간대를 사용중임을 나타낸다

스위스 취리히에 있는 컴퓨터에서 네트워크를 통해 뉴욕에 있는 `MySQL` 서버의 세션을 여는 경우, 세션의 시간대 설정을 바꿀수 있다.

```mysql
SET time_zone = 'Europe/Zurich';
```

```mysql
SELECT @@global.time_zone, @@session.time_zone;

@@global.time_zone|@@session.time_zone|
------------------+-------------------+
SYSTEM            |'Europe/Zurich'    |
```

## 시간 데이터 생성

시간 데이터 생성할수 있는 다음의 3가지이다.

- `date`, `datetime` 또는 `time` 열에서 데이터 복사
- `date`, `datetime` 또는 `time` 을 반환하는 내장 함수 실행
- 서버에서 확인된 시간 데이터를 문자열로 표현

이를 위한 `format` 지정을 사용하여 다양한 구성요소를 이해해야 한다.

### 시간 데이터 문자열 표시

날짜 구성요소는 다음과 같다

| 요소   | 정의        | 범위              |
| :--- | :-------- | :-------------- |
| YYYY | 연도, 세기 포함 | 1000 ~ 9999     |
| MM   | 월         | 01(월) ~ 12(12월) |
| DD   | 일         | 01 ~ 31         |
| HH   | 시간        | 00 ~ 23         |
| HHH  | 시간(경과)    | -838 ~ 838      |
| MI   | 분         | 00 ~ 59         |
| SS   | 초         | 00 ~ 59         |

서버가 `date`, `datetime` 또는 `time` 으로 해석할수 있는 문자열을 작성하려면 다음처럼 표시된 순서대로 다양한 구성요소를 조합해야 한다.

| 자료형       | 기본형식                |
| :-------- | ------------------- |
| date      | YYYY-MM-DD          |
| datetime  | YYYY-MM-DD HH:MI:SS |
| timestamp | YYYY-MM-DD HH-MI-SS |
| time      | HHH:MI:SS           |
`datetime` 열을 `2019-9-17 오후 3:30` 분으로 채우려면 다음과 같은 문자열을 만들어야 한다 

```sh
'2019-09-17 15:30:00'
```

다음과 같은 `datetime` 의 형식을 가진 문자열을, 내장 함수 및 `SQL` 구문과 같이 호출하면 데이터베이스 서버에서 변환을 수행한다

```mysql
UPDATE rental
SET return_date = '2019-09-17 15:30:00'
WHERE rental_id = 99999;
```

서버는 `SET` 절에 제공되는 문자열은 `datetime` 값이어야 한다.

서버는 `datetime` 형식에 포함된 $6$ 개의 구성요소 $년$, $월$, $일$, $시$, $분$, $초$ 로 `parsing` 해서 문자열을 변환하려 한다.

### 문자열을 날짜로 변환

`datetime` 값이라고 판달할수 없거나, 기본 형식이 아닌 형식을 사용해서 `datetime` 을 표시하려는 경우,
서버는 문자열을 `datetime` 으로 변환해야 한다.

이때 사용하는 함수가 `CAST` 내장 함수이다.

```mysql
SELECT CAST ('2019-09-17 15:30:00' AS DATETIME);
```

```sh
CAST ('2019-09-17 15:30:00' AS DATETIME)|
----------------------------------------+
                     2019-09-17 15:30:00|
```

다음은 `cast()` 함수로 `date` 값과 `time` 값을 생성하는 예제이다

```mysql
SELECT CAST ('2019-09-17' AS DATE) data_field, CAST ('108:17:15' AS TIME) time_field;
```

```sh
data_field|time_field|
----------+----------+
2019-09-17| 108:17:15|
```

>[!info] 이는 명시적이든 암시적이든 문자열이 날짜/시간 값으로 변환될 경우, 모든 날짜 구성요소를 요구되는 순서대로 제공해야 한다.

### 날짜 생성 함수

`CAST` 함수를 사용하기에는 [[#시간 데이터 문자열 표시]] 같은 적적한 형식이 아닐경우, 날자 문자열과 함께 형식 문자열을 제공하는 내장 함수가 필요하다

#### STR_TO_DATE 함수

`September 17, 2019` 문자열을 가져와 `date` 열을 업데이트하는데 사용해야 한다고 가정한다.

문자열이 `YYYY-MM-DD` 형식이 아니므로, `CAST` 함수를 사용할수 있도록 문자열을 형식에 맞게 다시 바꿔주는 대신 `STR_TO_DATE` 를 사용할수 있다.

```mysql
UPDATE rental
SET return_date = STR_TO_DATE('September 17, 2019', '%M %d, %Y')
WHERE rental_id = 99999;
```

`STR_TO_DATE` 함수의 두번째 인수는 날짜 문자열의 형식을 다음의 구성요소로 나타낸다.

>[!info] 현재 있는 구성요소들은 자주 사용한것들만 모아놓은것이다.<br>모든 구성요소는 [DATE_FORMAT](https://dev.mysql.com/doc/refman/8.4/en/date-and-time-functions.html#function_date-format) 에서 확인 가능하다

| 요소  | 정의                      |
| :-- | ----------------------- |
| %M  | 월명 (January - December) |
| %m  | 숫자로 나타낸 월 (01 - 12)     |
| %d  | 숫자로 나타낸 일 (01 - 31)     |
| %j  | 일년 중 몇번째 날 (001 - 366)  |
| %W  | 요일면 (Sunday - Saturday) |
| %Y  | 연도, 4자리 숫자              |
| %y  | 연도, 2자리 숫자              |
| %H  | 시간 (00 - 23)            |
| %h  | 시간 (01 - 12)            |
| %i  | 분 (00 - 59)             |
| %s  | 초 (00 - 59)             |
| %f  | 마이크로초 (000000 - 999999) |
| %p  | 오전 또는 오후                |
마치 `C Language` 의 `printf 의 data format` 처럼 사용되는것 같다 
각 부분마다, `Space` 를 구분자로 해서, 각 구분자에 있는 문자열이 어떠한 타입인지 명식하는 방식이다.

#### CURRENT_DATE(), CURRENT_TIME(), CURRENT_TIMESTAMP()

현재 날짜, 시간, 타임 스탬프 값을 출력해주는 유용한 함수이다

```mysql
SELECT CURRENT_DATE(), CURRENT_TIME(), CURRENT_TIMESTAMP();
```

## 시간 데이터 조작

시간 데이터 조작시 사용되는 `data type` 의 `format` 은 다음과 같다

| 기간명           | 정의                 |
| :------------ | ------------------ |
| second        | 초                  |
| minute        | 분                  |
| hour          | 시간                 |
| day           | 일 수                |
| month         | 개월 수               |
| year          | 년 수                |
| minute_second | `:` 으로 구분된 분 초     |
| hour_second   | `:` 으로 구분된 시, 분, 초 |
| year_month    | `-` 으로 구분된 년, 월    |
### 날짜를 반환하는 시간 함수
#### DATE_ADD(date, INTERVAL data type):  날짜를 더하는 함수

`DATE_ADD` 는 `date` 를 첫번째 인자로, 두번째 인자로 `INTERVAL data type` 을 넣어준다
예시는 다음과 같다

```mysql
UPDATE rental
SET return_date = DATE_ADD(return_date, INTERVAL '3:27:11' HOUR_SECOND)
WHERE rental_id = 99999;
```

`return_date` 에 `3:27:11` 을 더하여 `update` 한다. 

```mysql
UPDATE employee
SET birth_date = DATE_ADD(birth_date, INTERVAL '9-11' YEAR_MONTH)
WHERE emp_id = 4789;
```

`birth_date` 에 `9년 11개월` 을 더한다.
날짜에 기간을 더해야 하는 몇몇 상황이 발생한다

#### LAST_DAY(date): 해당 월의 마지막 일수를 반환하는 함수

은행 고객이 온라인 뱅킹 시스템에 로그인해서 월말에 이체를 예약한다면, 현재 월을 계산한 해당 월의 전체 일수를 계산하는 코드를 작성하는대신, `LAST_DAY` 함수로 처리할수 있다.

```mysql
SELECT LAST_DAY('2019-09-17');
```

```sh
LAST_DAY('2019-09-17')|
----------------------+
            2019-09-30|
```

`date` 나 `datetime` 값을 제공하는지 여부와 상관없이 `last_day` 함수는 항상 날짜를 반환한다.
이는 `2월` 의 마지막 날을 찾고 현재 연도가 윤년인지 아닌지 파악할때 유용하다.

`LAST_DAY` 의 반환값은 `date` 이다

### 문자열을 반환하는 시간 함수

문자열을 반환하는 대부분의 시간 함수는 날자 또는 시간의 일부를 추출하는데 사용된다

#### DAYNAME(date): `date` 의 요일을 알려주는 함수

```mysql
SELECT DAYNAME('2019-09-18');
```

```sh
DAYNAME('2019-09-18')|
---------------------+
Wednesday            |
```

#### EXTRACT(unit FROM date): 기간 자료형으로 원하는 날짜를 추출하는 함수

[[#시간 데이터 조작]] 에서의 **기간 자료형** 으로 원하는 날짜 요소를 정의하고, 추출한다.
다음은 `datetime` 에서 `YEAR`  만 추출하는 쿼리이다.

```mysql
SELECT EXTRACT(YEAR FROM '2019-09-18 22:19:05');
```

```sh
EXTRACT(YEAR FROM '2019-09-18 22:19:05')|
----------------------------------------+
                                    2019|
```

### 숫자를 반환하는 시간 함수

날짜로 작업할때의 또 다른 **일반적인 작업은 두개의 날짜 값을 가져와 두 날짜 사이의 기간(년, 주, 일)** 을 계산하는것이다

#### DATEDIFF(date, date): 두 날짜 사이의 전체 일 수를 계산하는 함수

다음은`74` 일 차이가 난다.

```mysql
SELECT DATEDIFF('2019-09-03', '2019-06-21');
```

```sh
DATEDIFF('2019-09-03', '2019-06-21')|
------------------------------------+
                                  74|
```

다음은 시간을 포함해서 첫번재 날짜 자정 1초전으로 설정하고, 두번째 날짜 자정 1초후로 설정하더라도 시간은 계산에 영향을 주지 않는다

```mysql
SELECT DATEDIFF('2019-09-03 23:59:59', '2019-06-21 00:00:01');
```

```sh
DATEDIFF('2019-09-03', '2019-06-21')|
------------------------------------+
                                  74|
```

만약, 이전 날짜를 먼저 지정하면 음수값을 반환한다

```mysql
SELECT DATEDIFF('2019-06-21', '2019-09-03');
```

```sh
DATEDIFF('2019-06-21', '2019-09-03')|
------------------------------------+
                                 -74|
```

## 변환 함수

`CAST()` 함수를 사용해서 문자열을 `datetime` 값으로 변환한다
이는 `SQL:2003` 표준에 포함되면 여러 데이터베이스에서 구현되는 `cast` 함수를 사용할것을 권장한다

`CAST` 함수를 사용하려면 값 또는 표현식, `as` 키워드 및 변환할 값의 자료형을 제공해야 한다.

```mysql
SELECT CAST('1452304' AS SIGNED INTEGER);
```

```sh
CAST('1452304' AS SIGNED INTEGER)|
---------------------------------+
                          1452304|
```

문자열을 숫자로 변환할때 `CAST()` 함수는 전체 문자열을 왼쪽에서 오른쪽으로 변환하려 한다.

```mysql
SELECT CAST('999ABC111' AS UNSIGNED INTEGER);
```

```sh
CAST('999ABC111' AS UNSIGNED INTEGER)|
-------------------------------------+
                                  999|
```

`UNSIGNED INTEGER` 로 변경한다.
왼쪽에서 부터 시작하며  `A` 는 숫자가 아니므로, $999$ 까지만 변환된다. 그리고 나머지는 버린다.

이는 숫자 변환에 실패했으므로, `WARNINGS` 를 통해 확인가능하다

```sh
Truncated incorrect INTEGER value: '999ABC111'
```

이는 올바르지 않은 `INTEGER` 로 일부를 생략했다고 말한다.
이는 `date`, `time`, `datetime` 값으로 변환할경우, [[#시간 데이터 문자열 표시]] 의 포멧을 사용하여 변환해야 한다.

```mysql
SELECT CAST ('2019-09-17 15:30:00' AS DATETIME);
```

```sh
CAST ('2019-09-17 15:30:00' AS DATETIME)|
----------------------------------------+
                     2019-09-17 15:30:00|
```

기본 형식의 포멧을 사용하지 않을 경우 [[#STR_TO_DATE 함수]] 를 사용하여, 처리해야 한다.

