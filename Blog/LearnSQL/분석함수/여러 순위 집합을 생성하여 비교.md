
다음은 마케팅 부서에서 매월 상위 5명의 고객에게 무료 영화 대여 서비스를 제공하는 예시이다.

그럼 첫번째로 매월 이용고객을 순위로 쿼리한다.

```mysql
SELECT
	customer_id,
	COUNT(*) cnt,
	MONTHNAME (rental_date) mn,
	RANK() OVER (
		PARTITION BY MONTHNAME(rental_date)
		ORDER BY COUNT(*) DESC
	) rnk
FROM rental r
GROUP BY 
	customer_id,
	MONTHNAME(rental_date);
```

```sh
customer_id|cnt|mn    |rnk|
-----------+---+------+---+
        148| 18|August|  1|
        119| 18|August|  1|
        569| 18|August|  1|
         15| 18|August|  1|
        342| 17|August|  5|
        266| 17|August|  5|
        141| 17|August|  5|
        418| 17|August|  5|
		...
```

상위 $5$ 명을 골라내기 위해 다음처럼 `WHERE` 절을 사용할수 있다.

```mysql
SELECT
	customer_id,
	mn,
	cnt,
	rnk
FROM (
	SELECT
		customer_id,
		COUNT(*) cnt,
		MONTHNAME (rental_date) mn,
		RANK() OVER (
			PARTITION BY MONTHNAME(rental_date)
			ORDER BY COUNT(*) DESC
		) rnk
FROM rental r
GROUP BY
	customer_id,
	MONTHNAME(rental_date)
) cust_rankings
WHERE rnk <= 5
ORDER BY mn, cnt, rnk;
```

```sh
customer_id|mn      |cnt|rnk
-----------+--------+---+---
        410|August  | 17|  5
         21|August  | 17|  5
        342|August  | 17|  5
        266|August  | 17|  5
        141|August  | 17|  5
        418|August  | 17|  5
        119|August  | 18|  1
        148|August  | 18|  1
         15|August  | 18|  1
        569|August  | 18|  1
        284|February|  2|  2
         43|February|  2|  2
        269|February|  2|  2
        155|February|  2|  2
        267|February|  2|  2
         53|February|  2|  2
         42|February|  2|  2
        163|February|  2|  2
        361|February|  2|  2
        448|February|  2|  2
        560|February|  2|  2
        216|February|  2|  2
        516|February|  2|  2
         15|February|  2|  2
        457|February|  2|  2
        208|February|  2|  2
        228|February|  2|  2
         60|February|  2|  2
        175|February|  2|  2
        354|February|  2|  2
        576|February|  2|  2
        107|February|  2|  2
         75|February|  3|  1
        595|July    | 19|  5
        137|July    | 19|  5
         30|July    | 19|  5
        526|July    | 19|  5
         64|July    | 19|  5
        354|July    | 19|  5
        366|July    | 19|  5
         91|July    | 19|  5
         75|July    | 20|  3
        236|July    | 20|  3
        102|July    | 21|  2
        148|July    | 22|  1
        526|June    |  9|  3
        561|June    |  9|  3
        329|June    |  9|  3
        295|June    |  9|  3
        267|June    |  9|  3
        213|June    |  9|  3
        457|June    |  9|  3
        454|June    | 10|  2
         31|June    | 11|  1
        245|May     |  6|  4
         53|May     |  6|  4
        239|May     |  6|  4
        269|May     |  6|  4
        161|May     |  6|  4
        207|May     |  6|  4
        251|May     |  6|  4
        274|May     |  6|  4
        596|May     |  6|  4
        371|May     |  6|  4
         19|May     |  6|  4
        109|May     |  7|  2
        506|May     |  7|  2
        197|May     |  8|  1
		...
```

>[!warning] 이게 왜 상위 5 명이지?
>
>이게 왜 상위 5명인지 이해가 안간다. `rnk` 값이 $5$ 와 같다면, 적어도 랭킹 $5$ 까지의 모든 고객이라고 하는게 맞지 않을까?<br><br> 내가 이해를 잘못한거일수도 있지만, 지금 출력결과로써는 상위 5 명이 아니다.<br><br>각 그룹별로 상위 5명을 선택하려면 어떻게 해야 할까? 다음처럼 가능할까?
>

```mysql
SELECT
	customer_id,
	mn,
	cnt,
	rnk
FROM (
		SELECT
		customer_id,
		COUNT(*) cnt,
		MONTHNAME (rental_date) mn,
		ROW_NUMBER () OVER (
		PARTITION BY MONTHNAME(rental_date)
		ORDER BY COUNT(*) DESC
	) rnk
	FROM rental r
	GROUP BY
	customer_id,
	MONTHNAME(rental_date)
) cust_rankings
WHERE rnk <= 5
GROUP BY customer_id, mn, rnk
ORDER BY mn, cnt, rnk;
```

```sh
customer_id|mn      |cnt|rnk|
-----------+--------+---+---+
        342|August  | 17|  5|
        148|August  | 18|  1|
        119|August  | 18|  2|
        569|August  | 18|  3|
         15|August  | 18|  4|
        516|February|  2|  2|
         15|February|  2|  3|
        457|February|  2|  4|
        208|February|  2|  5|
         75|February|  3|  1|
        366|July    | 19|  5|
        236|July    | 20|  3|
         75|July    | 20|  4|
        102|July    | 21|  2|
        148|July    | 22|  1|
		...
```

이렇게 하면  상위 $5$ 명이 추려진다.
하지만 이는 형평성에 어긋날 수 있다. 같은 개수의 주문중에서도 `customer_id` 에 의해 포함안될수 있기 때문이다.

이는 `rank` 를 사용하여, 처리하여 같은 순위를 가진 모든 사용자를 선택하는게 더 합리적일 수 있다.

>[!warning] 단, 번역된것이 이상한건지 내가 이해를 잘못한건지, `상위 5 명` 선택시 `rank` 를 사용한것은 여전히 잘못된것이라고 생각한다.


