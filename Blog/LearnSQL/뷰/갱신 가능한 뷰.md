
뷰집합을 사용하는 사용자가 데이터를 수정해야 한다면 어떻게 할까? `MySQL`  은 다음의 조건이 충족되면 뷰를 업데이트 할 수 있다.

## 갱신 조건

- `MAX()`, `MIN()`, `AVG()` 등의 집계함수가 사용되지 않는다.

- `GROUP BY` 또는 `HAVING` 절을 사용하지 않는다.

- `SELECT` 또는 `FROM` 절에 서브쿼리가 없으며, `WHERE` 절의 서브쿼리는 `FROM` 절의 테이블을 참조하지 않는다.

- `UNION`, `UNION ALL`, `DISTINCT` 를 사용하지 않는다.

- `FROM` 절에 최소한 하나 이상의 테이블 또는 갱신 가능한 `VIEW` 가 포함된다.

- `FROM` 절은 테이블이나 `VIEW`  둘 이상 있는 경우 `INNER JOIN` 만 사용한다.

```mysql
create view customer_vw
(
	customer_id,
	first_name,
	last_name,
	email
)
AS
SELECT
	customer_id,
	first_name,
	last_name,
	CONCAT(SUBSTR(email, 1, 2), '*****', SUBSTR(email, -4)) email
FROM customer;

UPDATE customer_vw
SET last_name = 'SMITH-ALLEN'
WHERE customer_id = 1;
```

이는 제대로 수정된다 하지만 다음은 되지 않는다

```mysql
UPDATE customer_vw
SET email ='MARY.SMITH-ALLEN@sakilacustomer.org'
WHERE customer_id = 1;
```

`email` 열을 표현식에서 파생되므로, 적용되지 않는다.

```mysql
INSERT INTO customer_vw
(
	customer_id,
	first_name,
	last_name
)
VALUES (99999, 'ROBART', 'SIMPSON');
```

이 역시 적용되지 않는다.
이는 `customer_vw` 에 값을 삽입하려는 경우 
실제 테이블에 들어가는 열 구문이 포함되지 않는다.

>[!note]  실제 테이블은 `customer` 테이블이다. <br> `customer` 테이블에서 `insert` 하기 위해서는 더 많은 열 정보가 필요하다.

### 복잡한 뷰 업데이트

다음은 여러 테이블을 포함한 `VIEW` 이다.

```mysql
CREATE VIEW customer_details
AS
SELECT
	c.customer_id,
	c.store_id ,
	c.first_name ,
	c.last_name ,
	c.address_id ,
	c.active ,
	c.create_date ,
	a.address,
	ct.city,
	cn.country,
	a.postal_code
FROM customer c
INNER JOIN address a
	ON a.address_id = c.address_id
INNER JOIN city ct
	ON ct.city_id = a.city_id
INNER JOIN country cn
	ON cn.country_id = ct.country_id
```

이는 [[#갱신 조건]] 에 나온것 대로 갱신이 이루어질수 있다.

>[!note] [[#갱신 조건]] 대로 `INNER JOIN` 을 사용했다.

```mysql
UPDATE customer_details
SET
	last_name = 'SMITH-ALLEN',
	active = 0
WHERE customer_id = 1;

UPDATE customer_details
SET
	address = '999 Mokingbird Lane'
WHERE customer_id = 1;
```
문제없이 갱신된다.

하지만 **하나의 구문으로 두 테이블의 열을 모두 업데이트하면 에러가 발생**한다

```mysql
UPDATE customer_details
SET
	last_name = 'SMITH-ALLEN',
	active = 0,
	address = '999 Mokingbird Lane'
WHERE customer_id = 1;
```

```sh
SQL Error [1393] [HY000]: Can not modify more than one base table through a join view 'sakila.customer_details'
```

>[!warning] `JOIN VIEW` 를 통해 하나의 기반 테이블보다 더 많은 테이블에서 수정할수 없다는 에러이다.

이는 `INSERT` 할때도 마찬가지이다.




