
[[정보 스키마]] 를 사용할수 있는 몇가지 방법을 책에서는 소개한다.

`information_schema` 뷰를 쿼리해서 스크립트를 직접 생성할수도 있다.
### 스키마 생성 스크립트

다음은 `sakila.catgory` 테이블의 스크립트로 생성하는 명령어이다

```mysql
CREATE TABLE category (
	category_id TINYINT UNSIGNED NOT NULL AUTO_INCREMENT,
	name VARCHAR(25) NOT NULL,
	last_update TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
	PRIMARY KEY (category_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```

다음은 위의 명령어를 생성하는 스크립트를 작성한다.

```mysql
SELECT
'CREATE TABLE category (' create_table_statement
UNION ALL
SELECT cols.txt
FROM (
SELECT concat(
' ',
column_name,
' ',
column_type,
CASE
WHEN is_nullable = 'NO' THEN ' not null'
ELSE ''
END,
CASE
WHEN extra IS NOT NULL AND extra LIKE 'DEFAULT_GENERATED%'
THEN CONCAT(' DEFAULT ', column_default, substr(extra, 18))
WHEN extra IS NOT NULL THEN CONCAT(' ', extra)
ELSE ''
END,
',') txt
FROM information_schema.columns
WHERE table_schema = 'sakila' AND table_name = 'category'
ORDER BY ordinal_position
) cols
UNION ALL
SELECT ')';
```

```sh
create_table_statement                                                           
-----------------------------------------------------------------------------+
CREATE TABLE category (                                                          
 last_update timestamp not null DEFAULT CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,
 name varchar(25) not null ,                                                    
)                                                                                
```

기본키 제약조건에 대한 정보를 검색하려면 `table_constraints` 및 `eky_column_usage` 뷰에 대한 쿼리를 추가하면 된다.

```mysql
SELECT
	'CREATE TABLE category (' create_table_statement
UNION ALL
SELECT cols.txt
FROM (
	SELECT 
		concat(
			' ',
			column_name,
			' ',
			column_type,
			CASE
			WHEN is_nullable = 'NO' THEN ' not null'
			ELSE ''
			END,
			CASE
			WHEN extra IS NOT NULL AND extra LIKE 'DEFAULT_GENERATED%'
			THEN CONCAT(' DEFAULT ', column_default, substr(extra, 18))
			WHEN extra IS NOT NULL THEN CONCAT(' ', extra)
			ELSE ''
			END,
			','
		) txt
FROM information_schema.columns
WHERE 
	table_schema = 'sakila' 
	AND table_name = 'category'
ORDER BY ordinal_position
) cols
UNION ALL
SELECT
	CONCAT(' CONSTRAINT PRIMARY KEY (')
UNION ALL
SELECT
	cols.txt
FROM (
	SELECT 
		CONCAT(
			CASE
			WHEN ordinal_position > 1 THEN ' ,'
			ELSE ' '
			END, column_name
		) txt
FROM information_schema.key_column_usage
WHERE
	table_schema = 'sakila'
	AND table_name = 'category'
	AND constraint_name = 'PRIMARY'
ORDER BY ordinal_position
) cols
UNION ALL
SELECT ' )'
UNION ALL
SELECT ')'
```

```sh
create_table_statement                                                     
--------------------------------------------------------------------------
CREATE TABLE category (                                                      
 category_id tinyint unsigned not null auto_increment,                           
 last_update timestamp not null DEFAULT CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP,
 name varchar(25) not null ,                                                    
 CONSTRAINT PRIMARY KEY (                                                        
 category_id                                                                   
 )                                                                               
)                                                                                
```

### 배포확인

기존 데이터베이스 개체를 관리하고, 새 스키마 개체와 코드를 배포할 수 있는 데이터베이스 유지 관리 기간을 허용한다.

이는 새 스키마 개체가 적절한 열, 인덱스, 기본 키를 가지고 있는지 확인하기 위해 검증 스크립트를 실행한다.

```mysql
SELECT
	tbl.table_name,
	(
		SELECT
		COUNT(*)
		FROM information_schema.columns clm
		WHERE
		clm.table_schema = tbl.table_schema
		AND clm.table_name = tbl.table_name
	) num_columns,
	(
		SELECT
		COUNT(*)
		FROM information_schema.statistics sta
		WHERE
		sta.table_schema = tbl.table_schema
		AND sta.table_name = tbl.table_name
		) num_idxs,
	(
		SELECT
		COUNT(*)
		FROM information_schema.table_constraints tc
		WHERE
		tc.table_schema = tbl.table_schema
		AND tc.table_name = tbl.table_name
		AND tc.constraint_type = 'PRIMARY KEY'
	) num_pk_keys
FROM information_schema.tables tbl
WHERE
	tbl.table_schema = 'sakila'
	AND tbl.table_type ='BASE TABLE'
ORDER BY 1;
```

```sh
TABLE_NAME   |num_columns|num_idxs|num_pk_keys|
-------------+-----------+--------+-----------+
actor        |          4|       2|          1|
address      |          9|       3|          1|
category     |          3|       1|          1|
city         |          4|       2|          1|
country      |          3|       1|          1|
customer     |          9|       4|          1|
film         |         13|       4|          1|
film_actor   |          3|       3|          1|
film_category|          3|       3|          1|
film_text    |          3|       3|          1|
inventory    |          4|       4|          1|
language     |          3|       1|          1|
payment      |          7|       4|          1|
rental       |          7|       7|          1|
staff        |         11|       3|          1|
store        |          4|       3|          1|
```

